rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function householdPath(householdId) {
      return /databases/$(database)/documents/households/$(householdId);
    }

    function memberPath(householdId, uid) {
      return /databases/$(database)/documents/households/$(householdId)/members/$(uid);
    }

    function locationPath(householdId, locationId) {
      return /databases/$(database)/documents/households/$(householdId)/locations/$(locationId);
    }

    function isMember(householdId) {
      return signedIn() && exists(memberPath(householdId, request.auth.uid));
    }

    function canSelfJoin(householdId) {
      return signedIn()
        && existsAfter(memberPath(householdId, request.auth.uid))
        && getAfter(memberPath(householdId, request.auth.uid)).data.joinCode == resource.data.inviteCode;
    }

    function isDayId(dayId) {
      return dayId in [
        'monday',
        'tuesday',
        'wednesday',
        'thursday',
        'friday',
        'saturday',
        'sunday',
      ];
    }

    function validOptionalString(data, key, maxSize) {
      return !(key in data) || data[key] == null || (data[key] is string && data[key].size() <= maxSize);
    }

    function validVersionMeta(meta) {
      return meta is map
        && meta.keys().hasOnly(['version', 'baseVersion', 'updatedAt', 'updatedBy', 'clientCounter'])
        && meta.version is int
        && meta.version >= 0
        && meta.baseVersion is int
        && meta.baseVersion >= 0
        && meta.updatedBy is string
        && meta.updatedBy.size() > 0
        && meta.updatedBy.size() <= 120
        && meta.clientCounter is int
        && meta.clientCounter >= 0
        && (!("updatedAt" in meta) || meta.updatedAt is timestamp);
    }

    function validMealPayload(data, householdId) {
      return data.keys().hasOnly(['mealName', 'cookUid', 'updatedAt', 'updatedBy'])
        && validOptionalString(data, 'mealName', 120)
        && (!("cookUid" in data)
          || data.cookUid == null
          || (
            data.cookUid is string
            && exists(memberPath(householdId, data.cookUid))
          ))
        && (!("updatedBy" in data)
          || data.updatedBy == request.auth.uid)
        && (!("updatedAt" in data) || data.updatedAt is timestamp);
    }

    function validMealDocLegacy(householdId) {
      return validMealPayload(request.resource.data, householdId);
    }

    function validMealDocEnvelope(householdId) {
      return request.resource.data.keys().hasOnly([
          'data',
          'updatedAt',
          'meta',
          'mealName',
          'cookUid',
          'updatedBy',
        ])
        && request.resource.data.data is map
        && validMealPayload(request.resource.data.data, householdId)
        && validVersionMeta(request.resource.data.meta)
        && (!("updatedAt" in request.resource.data) || request.resource.data.updatedAt is timestamp);
    }

    function validMealDoc(householdId) {
      return validMealDocLegacy(householdId) || validMealDocEnvelope(householdId);
    }

    function validGroceryPayload(data, householdId) {
      return data.keys().hasOnly([
          'name',
          'quantity',
          'notes',
          'locationId',
          'personTag',
          'personUid',
          'mealDayId',
          'completed',
          'createdBy',
          'updatedBy',
          'createdAt',
          'updatedAt',
        ])
        && (data.name is string)
        && data.name.size() > 0
        && data.name.size() <= 80
        && validOptionalString(data, 'quantity', 24)
        && validOptionalString(data, 'notes', 240)
        && validOptionalString(data, 'personTag', 50)
        && (!("locationId" in data)
          || data.locationId == null
          || (
            data.locationId is string
            && exists(locationPath(householdId, data.locationId))
          ))
        && (!("personUid" in data)
          || data.personUid == null
          || (
            data.personUid is string
            && exists(memberPath(householdId, data.personUid))
          ))
        && (!("mealDayId" in data)
          || data.mealDayId == null
          || (
            data.mealDayId is string
            && isDayId(data.mealDayId)
          ))
        && (!("completed" in data) || data.completed is bool)
        && (!("createdBy" in data)
          || data.createdBy == null
          || data.createdBy is string)
        && (!("updatedBy" in data)
          || data.updatedBy == request.auth.uid)
        && (!("createdAt" in data) || data.createdAt is timestamp)
        && (!("updatedAt" in data) || data.updatedAt is timestamp);
    }

    function validGroceryDocLegacy(householdId) {
      return validGroceryPayload(request.resource.data, householdId);
    }

    function validGroceryDocEnvelope(householdId) {
      return request.resource.data.keys().hasOnly([
          'data',
          'updatedAt',
          'meta',
          'name',
          'quantity',
          'notes',
          'locationId',
          'personTag',
          'personUid',
          'mealDayId',
          'completed',
          'createdBy',
          'updatedBy',
          'createdAt',
        ])
        && request.resource.data.data is map
        && validGroceryPayload(request.resource.data.data, householdId)
        && validVersionMeta(request.resource.data.meta)
        && (!("updatedAt" in request.resource.data) || request.resource.data.updatedAt is timestamp);
    }

    function validGroceryDoc(householdId) {
      return validGroceryDocLegacy(householdId) || validGroceryDocEnvelope(householdId);
    }

    function validLocationPayload(data) {
      return data.keys().hasOnly(['name', 'createdBy', 'createdAt'])
        && data.name is string
        && data.name.size() > 0
        && data.name.size() <= 40
        && data.createdBy == request.auth.uid
        && (!("createdAt" in data) || data.createdAt is timestamp);
    }

    function validLocationDoc() {
      return validLocationPayload(request.resource.data)
        || (
          request.resource.data.keys().hasOnly(['data', 'updatedAt', 'meta', 'name', 'createdBy', 'createdAt'])
          && request.resource.data.data is map
          && validLocationPayload(request.resource.data.data)
          && validVersionMeta(request.resource.data.meta)
          && (!("updatedAt" in request.resource.data) || request.resource.data.updatedAt is timestamp)
        );
    }

    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    match /households/{householdId} {
      allow read: if isMember(householdId);
      allow create: if signedIn()
        && request.resource.data.keys().hasOnly(['name', 'ownerUid', 'memberUids', 'inviteCode', 'createdAt', 'updatedAt'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 60
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.memberUids is list
        && request.resource.data.memberUids.hasAll([request.auth.uid])
        && request.resource.data.memberUids.size() == 1
        && request.resource.data.inviteCode is string
        && request.resource.data.inviteCode.size() >= 4
        && request.resource.data.inviteCode.size() <= 12;
      allow update: if isMember(householdId)
        && request.resource.data.ownerUid == resource.data.ownerUid
        && request.resource.data.memberUids is list
        && request.resource.data.memberUids.hasAll([request.auth.uid])
        || canSelfJoin(householdId)
          && request.resource.data.ownerUid == resource.data.ownerUid
          && request.resource.data.memberUids is list
          && request.resource.data.memberUids.hasAll([request.auth.uid]);
      allow delete: if signedIn() && isMember(householdId) && resource.data.ownerUid == request.auth.uid;

      match /members/{uid} {
        allow read: if isMember(householdId);
        allow create: if signedIn()
          && uid == request.auth.uid
          && exists(householdPath(householdId))
          && request.resource.data.uid == request.auth.uid
          && request.resource.data.displayName is string
          && request.resource.data.displayName.size() > 0
          && request.resource.data.displayName.size() <= 100
          && request.resource.data.role in ['owner', 'member']
          && request.resource.data.joinCode is string
          && request.resource.data.joinCode == get(householdPath(householdId)).data.inviteCode;
        allow update, delete: if isMember(householdId);
      }

      match /weeks/{weekId} {
        allow read, write: if isMember(householdId);

        match /days/{dayId} {
          allow read: if isMember(householdId);
          allow write: if isMember(householdId)
            && isDayId(dayId)
            && validMealDoc(householdId);
        }
      }

      match /groceryItems/{itemId} {
        allow read: if isMember(householdId);
        allow create, update: if isMember(householdId)
          && validGroceryDoc(householdId);
        allow delete: if isMember(householdId);
      }

      match /locations/{locationId} {
        allow read: if isMember(householdId);
        allow create, update: if isMember(householdId)
          && validLocationDoc();
        allow delete: if isMember(householdId);
      }

      match /activity/{activityId} {
        allow read: if isMember(householdId);
        allow create: if isMember(householdId)
          && request.resource.data.keys().hasOnly(['actorUid', 'actorName', 'type', 'message', 'createdAt'])
          && request.resource.data.actorUid == request.auth.uid
          && request.resource.data.actorName is string
          && request.resource.data.actorName.size() > 0
          && request.resource.data.actorName.size() <= 100
          && request.resource.data.type is string
          && request.resource.data.type.size() > 0
          && request.resource.data.type.size() <= 40
          && request.resource.data.message is string
          && request.resource.data.message.size() > 0
          && request.resource.data.message.size() <= 180;
        allow update, delete: if false;
      }
    }
  }
}
