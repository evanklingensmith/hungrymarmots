rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function householdPath(householdId) {
      return /databases/$(database)/documents/households/$(householdId);
    }

    function memberPath(householdId, uid) {
      return /databases/$(database)/documents/households/$(householdId)/members/$(uid);
    }

    function listedInHouseholdDoc(householdId) {
      return exists(householdPath(householdId))
        && listedInHousehold(get(householdPath(householdId)).data);
    }

    function isMember(householdId) {
      return signedIn()
        && (exists(memberPath(householdId, request.auth.uid)) || listedInHouseholdDoc(householdId));
    }

    function listedInHousehold(data) {
      return signedIn()
        && data.memberUids is list
        && request.auth.uid in data.memberUids;
    }

    function canSelfJoin(householdId) {
      return signedIn()
        && existsAfter(memberPath(householdId, request.auth.uid))
        && getAfter(memberPath(householdId, request.auth.uid)).data.joinCode == resource.data.inviteCode;
    }

    function validOptionalString(data, key, maxSize) {
      return !(key in data)
        || data[key] == null
        || (data[key] is string && data[key].size() <= maxSize);
    }

    function validMealTags(tags) {
      return tags is list
        && tags.size() <= 40;
    }

    function validMealIngredients(ingredients) {
      return ingredients is list
        && ingredients.size() <= 80;
    }

    function validIngredientPlan(plan) {
      return plan is list
        && plan.size() <= 80;
    }

    function validEaterUids(uids) {
      return uids is list
        && uids.size() <= 30;
    }

    function validHouseholdCreate() {
      return request.resource.data.keys().hasOnly([
          'name',
          'ownerUid',
          'memberUids',
          'inviteCode',
          'createdAt',
          'updatedAt',
        ])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 60
        && request.resource.data.ownerUid == request.auth.uid
        && request.resource.data.memberUids is list
        && request.resource.data.memberUids.hasAll([request.auth.uid])
        && request.resource.data.memberUids.size() == 1
        && request.resource.data.inviteCode is string
        && request.resource.data.inviteCode.size() >= 4
        && request.resource.data.inviteCode.size() <= 12;
    }

    function validHouseholdUpdate() {
      return request.resource.data.ownerUid == resource.data.ownerUid
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 60
        && request.resource.data.memberUids is list
        && request.auth.uid in request.resource.data.memberUids
        && request.resource.data.inviteCode is string
        && request.resource.data.inviteCode.size() >= 4
        && request.resource.data.inviteCode.size() <= 12;
    }

    function validMemberDoc(uid, householdId) {
      return request.resource.data.uid == uid
        && request.resource.data.displayName is string
        && request.resource.data.displayName.size() > 0
        && request.resource.data.displayName.size() <= 100
        && request.resource.data.role in ['owner', 'member']
        && request.resource.data.joinCode is string
        && request.resource.data.joinCode == (
          exists(householdPath(householdId))
            ? get(householdPath(householdId)).data.inviteCode
            : (
              existsAfter(householdPath(householdId))
                ? getAfter(householdPath(householdId)).data.inviteCode
                : null
            )
        );
    }

    function validStoreDoc() {
      return request.resource.data.keys().hasOnly(['name', 'createdBy', 'createdAt', 'updatedAt'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 50
        && request.resource.data.createdBy is string
        && request.resource.data.createdBy.size() > 0
        && request.resource.data.createdBy.size() <= 120;
    }

    function validMealDoc() {
      return request.resource.data.keys().hasOnly([
          'title',
          'description',
          'tags',
          'ingredients',
          'createdBy',
          'createdAt',
          'updatedAt',
        ])
        && request.resource.data.title is string
        && request.resource.data.title.size() > 0
        && request.resource.data.title.size() <= 120
        && request.resource.data.description is string
        && request.resource.data.description.size() <= 1000
        && validMealTags(request.resource.data.tags)
        && validMealIngredients(request.resource.data.ingredients)
        && request.resource.data.createdBy is string
        && request.resource.data.createdBy.size() > 0
        && request.resource.data.createdBy.size() <= 120;
    }

    function validWeekDayDoc() {
      return request.resource.data.keys().hasOnly([
          'mealId',
          'mealTitle',
          'cookUid',
          'eaterUids',
          'notes',
          'ingredientPlan',
          'updatedBy',
          'updatedAt',
        ])
        && validOptionalString(request.resource.data, 'mealId', 120)
        && validOptionalString(request.resource.data, 'mealTitle', 120)
        && validOptionalString(request.resource.data, 'cookUid', 120)
        && request.resource.data.eaterUids is list
        && validEaterUids(request.resource.data.eaterUids)
        && request.resource.data.notes is string
        && request.resource.data.notes.size() <= 1000
        && validIngredientPlan(request.resource.data.ingredientPlan)
        && request.resource.data.updatedBy == request.auth.uid;
    }

    function validGroceryDoc() {
      return request.resource.data.keys().hasOnly([
          'householdId',
          'name',
          'quantity',
          'notes',
          'storeId',
          'completed',
          'createdBy',
          'updatedBy',
          'createdAt',
          'updatedAt',
          'sourceWeekId',
          'sourceDayId',
          'sourceMealId',
          'autoGeneratedFromMeal',
        ])
        && request.resource.data.householdId is string
        && request.resource.data.householdId.size() > 0
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 80
        && validOptionalString(request.resource.data, 'quantity', 24)
        && validOptionalString(request.resource.data, 'notes', 240)
        && validOptionalString(request.resource.data, 'storeId', 120)
        && validOptionalString(request.resource.data, 'sourceWeekId', 120)
        && validOptionalString(request.resource.data, 'sourceDayId', 120)
        && validOptionalString(request.resource.data, 'sourceMealId', 120)
        && request.resource.data.completed is bool
        && request.resource.data.createdBy is string
        && request.resource.data.updatedBy is string
        && request.resource.data.updatedBy == request.auth.uid
        && request.resource.data.autoGeneratedFromMeal is bool;
    }

    function validPantryDoc() {
      return request.resource.data.keys().hasOnly([
          'name',
          'section',
          'sourceGroceryItemId',
          'autoFromGrocery',
          'createdBy',
          'updatedBy',
          'createdAt',
          'updatedAt',
        ])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 80
        && request.resource.data.section in ['weekly', 'other']
        && validOptionalString(request.resource.data, 'sourceGroceryItemId', 120)
        && request.resource.data.autoFromGrocery is bool
        && request.resource.data.createdBy is string
        && request.resource.data.updatedBy is string
        && request.resource.data.updatedBy == request.auth.uid;
    }

    function validActivityDoc() {
      return request.resource.data.keys().hasOnly([
          'actorUid',
          'actorName',
          'scope',
          'action',
          'message',
          'undo',
          'undone',
          'undoneBy',
          'undoneAt',
          'createdAt',
        ])
        && request.resource.data.actorUid == request.auth.uid
        && request.resource.data.actorName is string
        && request.resource.data.actorName.size() > 0
        && request.resource.data.actorName.size() <= 100
        && request.resource.data.scope is string
        && request.resource.data.scope.size() > 0
        && request.resource.data.scope.size() <= 40
        && request.resource.data.action is string
        && request.resource.data.action.size() > 0
        && request.resource.data.action.size() <= 60
        && request.resource.data.message is string
        && request.resource.data.message.size() > 0
        && request.resource.data.message.size() <= 220
        && (!("undo" in request.resource.data) || request.resource.data.undo == null || request.resource.data.undo is map)
        && (!("undone" in request.resource.data) || request.resource.data.undone is bool)
        && validOptionalString(request.resource.data, 'undoneBy', 120);
    }

    match /users/{uid} {
      allow read, write: if signedIn() && request.auth.uid == uid;
    }

    match /households/{householdId} {
      allow get: if listedInHousehold(resource.data) || isMember(householdId);
      allow list: if listedInHousehold(resource.data);
      allow create: if signedIn() && validHouseholdCreate();
      allow update: if (isMember(householdId) && validHouseholdUpdate())
        || (canSelfJoin(householdId) && validHouseholdUpdate());
      allow delete: if isMember(householdId) && resource.data.ownerUid == request.auth.uid;

      match /members/{uid} {
        allow read: if isMember(householdId);
        allow create: if signedIn()
          && uid == request.auth.uid
          && (exists(householdPath(householdId)) || existsAfter(householdPath(householdId)))
          && validMemberDoc(uid, householdId);
        allow update, delete: if isMember(householdId);
      }

      match /stores/{storeId} {
        allow read: if isMember(householdId);
        allow create: if isMember(householdId)
          && validStoreDoc()
          && request.resource.data.createdBy == request.auth.uid;
        allow update: if isMember(householdId)
          && validStoreDoc()
          && request.resource.data.createdBy == resource.data.createdBy;
        allow delete: if isMember(householdId);
      }

      match /meals/{mealId} {
        allow read: if isMember(householdId);
        allow create: if isMember(householdId)
          && validMealDoc()
          && request.resource.data.createdBy == request.auth.uid;
        allow update: if isMember(householdId)
          && validMealDoc()
          && request.resource.data.createdBy == resource.data.createdBy;
        allow delete: if isMember(householdId);
      }

      match /weeks/{weekId}/days/{dayId} {
        allow read: if isMember(householdId);
        allow create, update: if isMember(householdId)
          && dayId in ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']
          && validWeekDayDoc();
        allow delete: if isMember(householdId);
      }

      match /groceryItems/{itemId} {
        allow read: if isMember(householdId);
        allow create: if isMember(householdId)
          && validGroceryDoc()
          && request.resource.data.householdId == householdId
          && request.resource.data.createdBy == request.auth.uid;
        allow update: if isMember(householdId)
          && validGroceryDoc()
          && request.resource.data.householdId == householdId
          && request.resource.data.createdBy == resource.data.createdBy;
        allow delete: if isMember(householdId);
      }

      match /pantryItems/{itemId} {
        allow read: if isMember(householdId);
        allow create: if isMember(householdId)
          && validPantryDoc()
          && request.resource.data.createdBy == request.auth.uid;
        allow update: if isMember(householdId)
          && validPantryDoc()
          && request.resource.data.createdBy == resource.data.createdBy;
        allow delete: if isMember(householdId);
      }

      match /activity/{activityId} {
        allow read: if isMember(householdId);
        allow create: if isMember(householdId) && validActivityDoc();
        allow update: if isMember(householdId)
          && request.resource.data.actorUid == resource.data.actorUid
          && request.resource.data.createdAt == resource.data.createdAt;
        allow delete: if false;
      }
    }
  }
}
