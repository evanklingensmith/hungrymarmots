<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hungry Marmots</title>
    <style>
      :root {
        --bg: #f8f4e8;
        --bg-deep: #efe2c5;
        --surface: #fffdf8;
        --surface-soft: #f9f2e0;
        --ink: #1f1b13;
        --ink-soft: #665c4b;
        --accent: #0f766e;
        --accent-strong: #0b5f58;
        --danger: #b42318;
        --border: #d8c9ad;
        --shadow: 0 16px 36px rgba(56, 42, 18, 0.15);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Space Grotesk", "Avenir Next", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 95% 5%, rgba(15, 118, 110, 0.18), transparent 24%),
          radial-gradient(circle at 10% 90%, rgba(215, 106, 74, 0.14), transparent 22%),
          linear-gradient(145deg, var(--bg), var(--bg-deep));
        min-height: 100vh;
      }

      .app-shell {
        max-width: 1180px;
        margin: 0 auto;
        padding: 1.2rem;
      }

      .app-header,
      .view {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
      }

      .app-header {
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        align-items: flex-start;
      }

      .header-top h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      .header-top p {
        margin: 0.4rem 0 0;
        color: var(--ink-soft);
      }

      .user-chip {
        text-align: right;
        font-size: 0.9rem;
      }

      .user-chip strong {
        display: block;
      }

      .header-actions {
        margin-top: 0.8rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.55rem;
        flex-wrap: wrap;
      }

      #status-message {
        margin: 0.8rem 0 0;
        color: var(--ink-soft);
      }

      #mode-banner {
        margin: 0.45rem 0 0;
        color: #0f766e;
        font-size: 0.9rem;
        font-weight: 600;
      }

      #global-error {
        margin: 0.45rem 0 0;
        color: var(--danger);
        font-weight: 600;
        min-height: 1.1rem;
      }

      .view {
        padding: 1.2rem;
      }

      .hidden {
        display: none !important;
      }

      .stack {
        display: grid;
        gap: 0.9rem;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.85rem;
      }

      .card {
        background: var(--surface-soft);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 0.95rem;
      }

      .panel-list {
        margin: 0;
        padding: 0;
        list-style: none;
      }

      .panel-list li {
        border-bottom: 1px solid rgba(31, 27, 19, 0.12);
        padding: 0.55rem 0;
      }

      .panel-list li:last-child {
        border-bottom: 0;
      }

      .empty {
        color: var(--ink-soft);
        font-style: italic;
      }

      .meta {
        color: var(--ink-soft);
        font-size: 0.86rem;
      }

      label {
        display: grid;
        gap: 0.35rem;
        font-weight: 600;
        font-size: 0.91rem;
      }

      input,
      textarea,
      select,
      button {
        font: inherit;
      }

      input,
      textarea,
      select {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: white;
        padding: 0.5rem 0.6rem;
      }

      textarea {
        min-height: 88px;
        resize: vertical;
        line-height: 1.3;
        white-space: pre-wrap;
      }

      select[multiple] {
        min-height: 86px;
      }

      button {
        border: 1px solid transparent;
        border-radius: 10px;
        padding: 0.5rem 0.84rem;
        background: var(--accent);
        color: white;
        font-weight: 700;
        cursor: pointer;
      }

      button:hover {
        background: var(--accent-strong);
      }

      button:disabled {
        opacity: 0.55;
        cursor: default;
      }

      .ghost {
        background: transparent;
        color: var(--ink);
        border-color: var(--border);
      }

      .ghost:hover {
        background: rgba(15, 118, 110, 0.08);
      }

      .danger {
        background: #fee4e2;
        color: var(--danger);
        border-color: #fecdca;
      }

      .danger:hover {
        background: #ffd8d5;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 0.55rem;
      }

      .inline-form {
        display: grid;
        grid-template-columns: minmax(200px, 1.2fr) minmax(180px, 1fr) minmax(140px, 0.9fr) auto;
        gap: 0.55rem;
        align-items: end;
      }

      .tab-nav,
      .subtab-nav {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .tab-nav {
        margin-bottom: 1rem;
      }

      #household-gate {
        max-width: 840px;
        margin: 0 auto;
      }

      #household-gate h2 {
        margin: 0;
      }

      .tab-nav button.active,
      .subtab-nav button.active {
        background: var(--ink);
        color: #fff;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.65rem;
        margin-bottom: 0.8rem;
      }

      .panel-header h3 {
        margin: 0;
      }

      .week-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.7rem;
        margin-bottom: 0.85rem;
      }

      .planner-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
      }

      .planner-day {
        background: var(--surface-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.75rem;
        display: grid;
        gap: 0.6rem;
      }

      .planner-day h4 {
        margin: 0;
      }

      .meal-picker {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.4rem;
        border: 1px dashed var(--border);
        border-radius: 10px;
        padding: 0.45rem 0.55rem;
        background: #fff;
      }

      .meal-picker .title {
        font-weight: 700;
      }

      .store-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 0.75rem;
      }

      .store-column {
        background: var(--surface-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.7rem;
      }

      .store-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .grocery-item,
      .history-item,
      .pantry-item,
      .meal-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        padding: 0.55rem;
        margin-bottom: 0.5rem;
      }

      .grocery-item:last-child,
      .history-item:last-child,
      .pantry-item:last-child,
      .meal-item:last-child {
        margin-bottom: 0;
      }

      .grocery-item.done {
        background: rgba(15, 118, 110, 0.08);
      }

      .item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.4rem;
      }

      .item-row .title {
        font-weight: 700;
      }

      .meal-tags {
        display: flex;
        gap: 0.35rem;
        flex-wrap: wrap;
        margin: 0.4rem 0;
      }

      .tag {
        font-size: 0.78rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        background: rgba(15, 118, 110, 0.12);
        border: 1px solid rgba(15, 118, 110, 0.25);
      }

      .ingredient-list {
        margin: 0.4rem 0 0;
        padding-left: 1.1rem;
      }

      .ingredient-list li {
        margin: 0.12rem 0;
      }

      .ingredient-plan-row,
      .new-ingredient-row {
        display: grid;
        grid-template-columns: minmax(180px, 1.2fr) auto minmax(130px, 1fr) auto;
        gap: 0.45rem;
        align-items: center;
      }

      .ingredient-plan-row label,
      .new-ingredient-row label {
        display: flex;
        align-items: center;
        gap: 0.35rem;
      }

      .ingredient-plan-row input[type="checkbox"],
      .new-ingredient-row input[type="checkbox"] {
        width: auto;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(24, 16, 5, 0.45);
        display: grid;
        place-items: center;
        padding: 1rem;
        z-index: 40;
      }

      .modal-card {
        width: min(780px, 100%);
        max-height: 92vh;
        overflow: auto;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 1rem;
      }

      .modal-card.wide {
        width: min(980px, 100%);
      }

      .modal-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }

      .modal-head h2 {
        margin: 0;
      }

      .household-choice {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: left;
      }

      .household-choice.selected {
        border-color: var(--accent);
      }

      @media (max-width: 920px) {
        .inline-form {
          grid-template-columns: 1fr;
        }

        .two-col,
        .ingredient-plan-row,
        .new-ingredient-row {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 760px) {
        .header-top {
          flex-direction: column;
        }

        .user-chip {
          text-align: left;
        }

        .header-actions {
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="header-top">
          <div>
            <h1>Hungry Marmots</h1>
            <p>Meal planning, grocery coordination, and pantry tracking for your household.</p>
          </div>
          <div class="user-chip">
            <strong id="user-name">Not signed in</strong>
            <span id="user-email"></span>
          </div>
        </div>

        <div class="header-actions">
          <button id="household-open-button" type="button" class="ghost hidden">Household</button>
          <button id="auth-action-button" type="button" class="ghost hidden">Sign out</button>
        </div>

        <p id="status-message">Loading app...</p>
        <p id="mode-banner" class="hidden"></p>
        <p id="global-error" role="alert" aria-live="polite"></p>
      </header>

      <section id="login-view" class="view stack">
        <h2>Choose how to continue</h2>
        <p>Sign in for shared households, or choose local-only mode to keep data on this device.</p>
        <div class="actions">
          <button id="login-button" type="button">Continue with Google</button>
          <button id="local-only-button" type="button" class="ghost">Use local-only mode</button>
        </div>
        <p id="login-helper" class="meta"></p>
      </section>

      <section id="app-view" class="view hidden">
        <section id="household-gate" class="stack hidden">
          <article class="card stack">
            <h2>Set up your household</h2>
            <p id="household-gate-status" class="meta">Create a household or join one with an invite code to continue.</p>
          </article>

          <div class="two-col">
            <article class="card stack">
              <h3>Create household</h3>
              <form id="household-gate-create-form" class="stack">
                <label>
                  Household name
                  <input id="household-gate-name" type="text" maxlength="60" required placeholder="Maple Street" />
                </label>
                <button type="submit">Create household</button>
              </form>
            </article>

            <article class="card stack">
              <h3>Join household</h3>
              <form id="household-gate-join-form" class="stack">
                <label>
                  Household id
                  <input id="household-gate-id" type="text" required placeholder="household-abc" />
                </label>
                <label>
                  Invite code
                  <input id="household-gate-code" type="text" required placeholder="AB12CD" />
                </label>
                <button type="submit" class="ghost">Join household</button>
              </form>
            </article>
          </div>
        </section>

        <div id="main-app-content">
          <div class="tab-nav" role="tablist" aria-label="Main navigation tabs">
            <button type="button" role="tab" aria-selected="true" class="active" data-tab-target="weekly">Weekly meals</button>
            <button type="button" role="tab" aria-selected="false" data-tab-target="grocery">Grocery list</button>
            <button type="button" role="tab" aria-selected="false" data-tab-target="meals">Meals we make</button>
            <button type="button" role="tab" aria-selected="false" data-tab-target="pantry">Pantry</button>
          </div>

          <section id="weekly-panel" role="tabpanel" class="stack">
            <div class="week-header">
              <div class="actions">
                <button id="week-prev" type="button" class="ghost">Previous week</button>
                <button id="week-next" type="button" class="ghost">Next week</button>
              </div>
              <strong id="week-label"></strong>
            </div>
            <div id="weekly-grid" class="planner-grid"></div>
          </section>

          <section id="grocery-panel" role="tabpanel" class="hidden stack">
            <div class="panel-header">
              <h3>Shared grocery list</h3>
              <button id="manage-stores-button" type="button" class="ghost">Manage stores</button>
            </div>

            <form id="grocery-add-form" class="inline-form">
              <label>
                Item
                <input id="grocery-add-name" type="text" maxlength="80" required placeholder="Milk" />
              </label>
              <label>
                Notes
                <input id="grocery-add-notes" type="text" maxlength="240" placeholder="2% if available" />
              </label>
              <label>
                Store
                <select id="grocery-add-store"></select>
              </label>
              <button type="submit">Add item</button>
            </form>

            <div class="subtab-nav" role="tablist" aria-label="Grocery views">
              <button id="grocery-view-list-button" type="button" class="active">List</button>
              <button id="grocery-view-history-button" type="button" class="ghost">History</button>
            </div>

            <div id="grocery-list-view" class="stack">
              <div id="grocery-stores-grid" class="store-grid"></div>
              <article class="card">
                <h4>Weekly pantry from checked items</h4>
                <ul id="grocery-weekly-pantry-list" class="panel-list"></ul>
              </article>
            </div>

            <div id="grocery-history-view" class="hidden">
              <ul id="grocery-history-list" class="panel-list"></ul>
            </div>
          </section>

          <section id="meals-panel" role="tabpanel" class="hidden stack">
            <div class="panel-header">
              <h3>Meals we make</h3>
              <button id="add-meal-button" type="button">Add meal</button>
            </div>

            <form id="meal-search-form" class="inline-form" autocomplete="off">
              <label>
                Text search
                <input id="meal-search-text" type="text" placeholder="Title or description" />
              </label>
              <label>
                Tag
                <input id="meal-search-tag" type="text" placeholder="quick" />
              </label>
              <label>
                Ingredient
                <input id="meal-search-ingredient" type="text" placeholder="tomato" />
              </label>
              <button id="meal-search-reset" type="button" class="ghost">Reset</button>
            </form>

            <div id="meals-list" class="stack"></div>
          </section>

          <section id="pantry-panel" role="tabpanel" class="hidden stack">
            <div class="panel-header">
              <h3>Pantry</h3>
              <span class="meta">Right-click pantry items to move between weekly and other.</span>
            </div>

            <div class="subtab-nav" role="tablist" aria-label="Pantry views">
              <button id="pantry-view-list-button" type="button" class="active">List</button>
              <button id="pantry-view-history-button" type="button" class="ghost">History</button>
            </div>

            <div id="pantry-list-view" class="two-col">
              <article class="card">
                <h4>Weekly</h4>
                <ul id="pantry-weekly-list" class="panel-list"></ul>
              </article>

              <article class="card">
                <h4>Other</h4>
                <ul id="pantry-other-list" class="panel-list"></ul>
              </article>
            </div>

            <div id="pantry-history-view" class="hidden">
              <ul id="pantry-history-list" class="panel-list"></ul>
            </div>
          </section>
        </div>
      </section>
    </div>

    <div id="household-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="household-modal-title">
      <div class="modal-card stack">
        <div class="modal-head">
          <h2 id="household-modal-title">Household setup</h2>
          <button id="household-modal-close" type="button" class="ghost">Close</button>
        </div>

        <p id="household-modal-status" class="meta"></p>
        <p id="active-household-invite-code" class="meta"></p>

        <div class="two-col">
          <article class="card stack">
            <h3>Your households</h3>
            <ul id="household-list" class="panel-list"></ul>
          </article>

          <article class="card stack">
            <h3>Create household</h3>
            <form id="create-household-form" class="stack">
              <label>
                Household name
                <input id="household-name" type="text" maxlength="60" required placeholder="Maple Street" />
              </label>
              <button type="submit">Create household</button>
            </form>

            <h3>Join household</h3>
            <form id="join-household-form" class="stack">
              <label>
                Household id
                <input id="join-household-id" type="text" required placeholder="household-abc" />
              </label>
              <label>
                Invite code
                <input id="join-household-code" type="text" required placeholder="AB12CD" />
              </label>
              <button type="submit" class="ghost">Join household</button>
            </form>
          </article>
        </div>
      </div>
    </div>

    <div id="meal-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="meal-modal-title">
      <div class="modal-card wide stack">
        <div class="modal-head">
          <h2 id="meal-modal-title">Add meal for day</h2>
          <button id="meal-modal-close" type="button" class="ghost">Close</button>
        </div>

        <form id="meal-modal-form" class="stack">
          <input id="meal-day-id" type="hidden" />

          <label>
            Use existing meal
            <select id="meal-existing-select"></select>
          </label>

          <div id="meal-existing-config" class="stack"></div>

          <details id="new-meal-details" class="card">
            <summary>Create a new meal</summary>
            <div class="stack" style="margin-top: 0.7rem;">
              <label>
                Title
                <input id="new-meal-title" type="text" maxlength="120" placeholder="Lemon chicken" />
              </label>
              <label>
                Description
                <textarea id="new-meal-description" maxlength="1000" placeholder="Simple weeknight meal"></textarea>
              </label>
              <label>
                Tags (comma separated)
                <input id="new-meal-tags" type="text" placeholder="quick, one-pan" />
              </label>
              <div class="stack">
                <div class="actions">
                  <h4 style="margin: 0;">Ingredients</h4>
                  <button id="add-new-meal-ingredient" type="button" class="ghost">Add ingredient</button>
                </div>
                <div id="new-meal-ingredients" class="stack"></div>
              </div>
            </div>
          </details>

          <button type="submit">Apply to this day</button>
        </form>
      </div>
    </div>

    <div id="stores-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="stores-modal-title">
      <div class="modal-card stack">
        <div class="modal-head">
          <h2 id="stores-modal-title">Manage stores</h2>
          <button id="stores-modal-close" type="button" class="ghost">Close</button>
        </div>

        <form id="add-store-form" class="actions">
          <input id="store-name" type="text" maxlength="50" required placeholder="Trader Joe's" />
          <button type="submit">Add store</button>
        </form>

        <ul id="stores-manage-list" class="panel-list"></ul>
      </div>
    </div>

    <script defer src="/__/firebase/12.9.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.9.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.9.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js"></script>
    <script>
      // Fallback for non-Hosting environments.
      window.firebaseConfig = window.firebaseConfig || {
        apiKey: "AIzaSyAwz-PJRBfAa1yyVosCXCRi-Vz0ll9o9BQ",
        authDomain: "hungrymarmots.firebaseapp.com",
        projectId: "hungrymarmots",
        storageBucket: "hungrymarmots.firebasestorage.app",
        messagingSenderId: "81731552729",
        appId: "1:81731552729:web:3240811c6fa16f511a05c8"
      };
    </script>
    <script type="module" src="/app/main.mjs?v=__BUILD_VERSION__"></script>
  </body>
</html>
